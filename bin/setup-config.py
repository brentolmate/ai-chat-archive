#!/usr/bin/env python3
"""
AI Chat Archive Setup Wizard

Interactive first-run configuration setup.
Creates config/config.yaml based on user preferences.
"""

import os
import sys
from pathlib import Path
from typing import Dict, Any


def print_header(text: str):
    """Print a formatted header."""
    print("\n" + "=" * 60)
    print(f"  {text}")
    print("=" * 60)


def print_section(text: str):
    """Print a section header."""
    print(f"\n{text}")
    print("-" * len(text))


def get_path_input(prompt: str, default: str) -> Path:
    """Get a path from user with validation."""
    while True:
        user_input = input(f"{prompt} [{default}]: ").strip()
        path_str = user_input if user_input else default
        path = Path(path_str).expanduser()

        # For new paths, ask if they want to create
        if not path.exists():
            create = input(f"  Path doesn't exist. Create it? [y/N]: ").strip().lower()
            if create == 'y':
                try:
                    path.mkdir(parents=True, exist_ok=True)
                    print(f"  ✓ Created: {path}")
                except Exception as e:
                    print(f"  ✗ Error creating path: {e}")
                    continue
            else:
                print(f"  Please provide a valid path.")
                continue

        return path


def get_yes_no(prompt: str, default: bool = True) -> bool:
    """Get a yes/no response from user."""
    default_str = "Y/n" if default else "y/N"
    while True:
        response = input(f"{prompt} [{default_str}]: ").strip().lower()
        if not response:
            return default
        if response in ['y', 'yes']:
            return True
        if response in ['n', 'no']:
            return False
        print("  Please enter 'y' or 'n'.")


def get_choice(prompt: str, choices: list, default: int = 0) -> str:
    """Get a choice from a list of options."""
    print(f"\n{prompt}")
    for i, choice in enumerate(choices):
        default_marker = " (default)" if i == default else ""
        print(f"  {i + 1}. {choice}{default_marker}")

    while True:
        response = input(f"Enter choice [1-{len(choices)}]: ").strip()
        if not response:
            return choices[default]
        try:
            index = int(response) - 1
            if 0 <= index < len(choices):
                return choices[index]
        except ValueError:
            pass
        print(f"  Please enter a number between 1 and {len(choices)}.")


def generate_config(
    archive_path: Path,
    import_root: Path,
    human_os_enabled: bool,
    human_os_path: Path,
    domains: list,
) -> Dict[str, Any]:
    """Generate configuration dictionary."""
    config = {
        "archive": {
            "path": str(archive_path).replace(str(Path.home()), "~")
        },
        "import_sources": {
            "claude": str(import_root / "claude export/conversations.json").replace(str(Path.home()), "~"),
            "chatgpt": str(import_root / "CHAT GPT Archive/conversations.json").replace(str(Path.home()), "~")
        },
        "human_os": {
            "enabled": human_os_enabled,
            "path": str(human_os_path).replace(str(Path.home()), "~"),
            "domains": domains
        },
        "domains": {
            "default": "system",
            "custom": {
                "@loopwalker": ["music", "song", "loopwalker", "shadow work", "frequency", "audio", "lyrics", "melody"],
                "@pulsekeeper": ["heart", "coherence", "adhd", "2e", "frequency", "nervous system", "regulation"],
                "@shadow-institute": ["dyslexia", "twice-exceptional", "2e", "gifted", "neurodivergent", "learning difference"],
                "@unlimited-band": ["band", "collaboration", "music group", "bandmate"],
                "@brent": ["hyperfocus", "dyslexia", "pattern recognition", "brand", "positioning", "website"],
                "@gal": ["connection", "outreach", "networking", "crm", "warm", "dm", "comment"],
                "@system": ["sprint", "workflow", "process", "system", "automation", "skill"]
            }
        },
        "anthropic": {
            "api_key_env": "ANTHROPIC_API_KEY",
            "model": "claude-3-haiku-20240307",
            "max_tokens_summary": 200,
            "max_tokens_outputs": 300
        }
    }
    return config


def write_config(config: Dict[str, Any], config_path: Path):
    """Write configuration to file."""
    import yaml

    # Add header comment
    config_content = f"""# AI Chat Archive Configuration
# Generated by setup-config.py
#
# You can edit this file manually to customize settings.
# See config/config.yaml.example for all available options.

"""

    # Convert config to YAML
    yaml_content = yaml.dump(config, default_flow_style=False, sort_keys=False)

    with open(config_path, 'w') as f:
        f.write(config_content + yaml_content)


def main():
    """Main setup wizard."""
    print_header("AI Chat Archive Setup Wizard")

    print("""
This wizard will help you configure your AI Chat Archive system.

You'll be asked to:
1. Choose where to store archived conversations
2. Configure import source locations
3. Set up optional Human OS integration
4. Customize domain detection (optional)

At the end, a config.yaml file will be created with your settings.
""")

    input("Press Enter to continue...")

    # ========================================================================
    # Archive Location
    # ========================================================================
    print_section("Step 1: Archive Location")

    default_archive = Path("~/AI-CHAT-ARCHIVE")
    archive_path = get_path_input(
        "Where should conversations be archived?",
        str(default_archive)
    )

    # ========================================================================
    # Import Sources
    # ========================================================================
    print_section("Step 2: Import Sources")

    default_import = Path("~/RAW-AI-CHAT-IMPORT")
    print("\nThis is where you'll place your AI chat export files.")
    print("Supported formats: Claude (conversations.json), ChatGPT (conversations.json)")

    import_root = get_path_input(
        "Where are your AI chat export files located?",
        str(default_import)
    )

    # ========================================================================
    # Human OS Integration
    # ========================================================================
    print_section("Step 3: Human OS Integration (Optional)")

    print("""
Human OS integration enables intelligent domain and tag detection
by reading your Sprint.md and domain INDEX files.

If you don't use Human OS, the system will use keyword-based
detection instead (still works well!).
""")

    human_os_enabled = get_yes_no("Enable Human OS integration?", default=False)

    human_os_path = Path("~/Human")
    domains = []

    if human_os_enabled:
        human_os_path = get_path_input(
            "Where is your Human OS located?",
            str(human_os_path)
        )

        print("\nWhich domains should be loaded?")
        print("Enter domain names separated by commas, or press Enter for defaults.")
        print("Defaults: brent, gal, loopwalker, pulsekeeper, shadow-institute, unlimited-band")

        domains_input = input("Domains: ").strip()
        if domains_input:
            domains = [d.strip() for d in domains_input.split(',')]
        else:
            domains = ["brent", "gal", "loopwalker", "pulsekeeper", "shadow-institute", "unlimited-band"]

    # ========================================================================
    # Advanced Configuration
    # ========================================================================
    print_section("Step 4: Advanced Configuration (Optional)")

    advanced = get_yes_no("Configure advanced options?", default=False)

    if advanced:
        print("\nAdvanced options allow you to:")
        print("- Customize domain keywords")
        print("- Change Claude API model")
        print("- Adjust token limits")
        print("\nYou can edit these later in config/config.yaml")
        input("Press Enter to continue...")

    # ========================================================================
    # Generate Configuration
    # ========================================================================
    config = generate_config(
        archive_path=archive_path,
        import_root=import_root,
        human_os_enabled=human_os_enabled,
        human_os_path=human_os_path,
        domains=domains
    )

    # ========================================================================
    # Write Configuration
    # ========================================================================
    print_section("Step 5: Save Configuration")

    config_dir = Path(__file__).parent.parent / "config"
    config_dir.mkdir(exist_ok=True)
    config_path = config_dir / "config.yaml"

    if config_path.exists():
        overwrite = get_yes_no(f"config.yaml already exists. Overwrite?", default=False)
        if not overwrite:
            print("\nSetup cancelled. Existing configuration preserved.")
            return

    try:
        write_config(config, config_path)
        print(f"\n✓ Configuration saved to: {config_path}")
    except ImportError:
        print("\n✗ Error: PyYAML not installed.")
        print("  Install with: pip install pyyaml")
        print("\n  Falling back to manual configuration...")
        print("  Please copy config/config.yaml.example to config/config.yaml")
        print("  and edit it manually.")
        return
    except Exception as e:
        print(f"\n✗ Error writing configuration: {e}")
        return

    # ========================================================================
    # Summary
    # ========================================================================
    print_header("Setup Complete!")

    print(f"""
Your AI Chat Archive has been configured:

Archive Location:    {archive_path}
Import Sources:      {import_root}
Human OS:            {'Enabled' if human_os_enabled else 'Disabled'}
""")

    if human_os_enabled:
        print(f"Human OS Path:       {human_os_path}")
        print(f"Domains:             {', '.join(domains)}")
        print()

    print("""
Next Steps:

1. Place your AI chat exports in the import folder:
   - Claude: {import_root}/claude export/conversations.json
   - ChatGPT: {import_root}/CHAT GPT Archive/conversations.json

2. Test with a sample import:
   cd {archive_root}/bin
   ./import-chats.py --sample --count 5

3. If satisfied, run full import:
   ./import-chats.py --source all

4. (Optional) Install Claude Code skills:
   ./install-skills.sh

For more information, see:
- QUICKSTART.md     - 5-minute setup guide
- CONFIGURATION.md  - All configuration options
- IMPORT.md         - Detailed import guide
""".format(
        import_root=import_root,
        archive_root=archive_path.parent
    ))

    print("=" * 60)


if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print("\n\nSetup cancelled by user.")
        sys.exit(0)
